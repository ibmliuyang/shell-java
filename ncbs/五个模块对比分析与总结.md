# 五个改造模块对比分析与总结

## 模块复杂度对比

| 模块名称 | 复杂度 | 代码行数 | 核心特点 | API调用数 |
|---------|--------|----------|----------|-----------|
| ift_ncbs_ccllna_acct | ★★★★★ | 269行 | 双API调用+复杂过滤 | 3个API |
| ift_ncbs_ccllnb_basic_attr | ★★★☆☆ | 196行 | 标准模式+完整日志 | 1个API |
| ift_ncbs_ccllnb_chk_write_off | ★★☆☆☆ | 170行 | 简化日志+核心功能 | 1个API |
| ift_ncbs_ccllnb_non_perfmg_asset | ★☆☆☆☆ | 124行 | 极简模式+最小日志 | 1个API |
| ift_ncbs_cgmdab_cl_loan_rlvc | ★★★☆☆ | 205行 | 日期过滤+标准流程 | 1个API |

## 核心功能差异分析

### 1. ift_ncbs_ccllna_acct（对公贷款账户主表）- 最复杂模块

**独特功能**：
- **双API数据获取**：调用两个API分别获取维护借据号和排除借据号
- **复杂数据过滤**：两步过滤逻辑，先包含后排除
- **完整错误处理**：每个API调用都有详细的错误检查

**关键代码特点**：
```bash
# 双API调用
maintain_api_url="http://tms-app-cdc:19201/webapi/ncbs-ccllna-acct/getMaintainLnDueBillNos"
exclusion_api_url="http://tms-app-cdc:19201/webapi/ncbs-ccllna-acct/getExclusionLnDueBillNos"

# 两步过滤逻辑
awk -F '\\|\\+\\|' 'NR==FNR {values[$1]; next} $1 in values' "$maintain_file" "$unzip_data_file" > temp1.txt
awk -F '\\|\\+\\|' 'NR==FNR {values[$1]; next} !($1 in values)' "$exclusion_file" temp1.txt > temp2.txt
```

**适用场景**：需要复杂业务规则过滤的核心业务数据

### 2. ift_ncbs_ccllnb_basic_attr（对公贷款属性表）- 标准模块

**功能特点**：
- **标准处理流程**：文件解压→API调用→清理
- **完整日志记录**：保留所有关键步骤的日志
- **标准错误处理**：包含所有必要的检查点

**关键代码特点**：
```bash
# 标准的单API调用
api_url="http://tms-app-cdc:19201/webapi/ncbs-ccllnb-basic-attr/sync"

# 完整的日志记录
echo `date "+%Y-%m-%d %H:%M:%S"` "处理后文件行数: $line_count" >> ${LOGFILE}
echo `date "+%Y-%m-%d %H:%M:%S"` "请求参数: $request_data" >> ${LOGFILE}
```

**适用场景**：大多数标准业务数据处理

### 3. ift_ncbs_ccllnb_chk_write_off（对公贷款核销表）- 简化模块

**功能特点**：
- **精简日志**：去除部分非关键日志记录
- **保持核心功能**：所有必要功能都保留
- **快速执行**：减少I/O操作

**关键代码特点**：
```bash
# 简化的日志记录（相比basic_attr）
# 去除了部分详细的中间步骤日志
```

**适用场景**：处理量大、对性能要求较高的数据

### 4. ift_ncbs_ccllnb_non_perfmg_asset（对公贷款不良资产表）- 极简模块

**功能特点**：
- **最小化设计**：只保留核心必要功能
- **极简日志**：最少的日志记录
- **高效执行**：最快的执行速度

**关键代码特点**：
```bash
# 极简的锁函数
tmsLock(){
	if [ -f ${CHECK_LOCK_FILE} ] ;then
        echo "100"
        exit 100
	else
		touch ${CHECK_LOCK_FILE}
	fi
}

# 极简的错误处理
if [ -z "$files" ]; then
    fail='-1'
    echo $fail
    tmsUnlock
    exit 1
fi
```

**适用场景**：数据量小、处理简单、对性能要求极高的场景

### 5. ift_ncbs_cgmdab_cl_loan_rlvc（抵债资产对公贷款关联表）- 过滤模块

**独特功能**：
- **按日期过滤**：根据维护日期字段过滤数据
- **可配置列**：维护日期列号可配置
- **智能过滤**：只处理昨天维护的数据

**关键代码特点**：
```bash
# 维护日期列配置
maintain_date_col=47

# 按日期过滤数据
awk -F '\\|\\+\\|' -v maintain_date_col="$maintain_date_col" -v yesterday_with_dash="$yesterday_with_dash" \
'$maintain_date_col == yesterday_with_dash' "$unzip_data_file" > temp.txt
```

**适用场景**：需要按时间维度过滤的增量数据处理

## 设计模式总结

### 1. 模板方法模式
所有模块都遵循相同的基本流程：
```
初始化 → 加锁 → 文件发现 → 文件处理 → 业务逻辑 → API调用 → 清理 → 解锁
```

### 2. 策略模式
不同模块在业务逻辑层采用不同策略：
- **ccllna_acct**：双API获取+双重过滤策略
- **basic_attr**：标准处理策略
- **chk_write_off**：简化处理策略
- **non_perfmg_asset**：极简处理策略
- **cgmdab_cl_loan_rlvc**：日期过滤策略

### 3. 观察者模式
通过详细的日志记录实现处理过程的可观察性：
```bash
echo `date "+%Y-%m-%d %H:%M:%S"` "操作描述" >> ${LOGFILE}
```

## API接口标准化

### 统一的API调用格式
```bash
# 超时设置
time_url="--connect-timeout 30 --max-time 1800"

# 标准请求格式
request_data=$(cat <<EOF
{
    "filePath": "${work_dir}/${TARGET_FILE}",
    "processDate": "${yesterday_with_dash}",
    "tableName": "tp_ncbs_${org_table_name}"
}
EOF
)

# 标准调用方式
result=`curl -s $time_url -X POST -H "Content-Type: application/json" -d "$request_data" $api_url`
```

### API端点命名规范
- **同步接口**：`/webapi/模块名/sync`
- **查询接口**：`/webapi/模块名/getXxxXxx`
- **服务器地址**：`http://tms-app-cdc:19201`

## 错误处理策略

### 统一的返回码规范
- **成功**：0
- **失败**：-1
- **重复执行**：100

### 错误处理最佳实践
1. **锁检查**：防止重复执行
2. **文件检查**：确保文件存在
3. **API检查**：验证API调用结果
4. **清理保证**：异常时确保解锁
5. **日志记录**：详细记录错误信息

## 性能优化策略

### 不同模块的优化重点

1. **ccllna_acct**（复杂业务）
   - 优化数据过滤算法
   - 减少临时文件I/O
   - 并行API调用（如果业务允许）

2. **basic_attr**（标准模式）
   - 平衡日志详细度和性能
   - 优化文件处理流程

3. **chk_write_off**（简化模式）
   - 进一步减少非必要日志
   - 优化文件操作

4. **non_perfmg_asset**（极简模式）
   - 最小化所有非核心功能
   - 追求极致执行速度

5. **cgmdab_cl_loan_rlvc**（过滤模式）
   - 优化awk过滤性能
   - 考虑索引优化

## 运维监控建议

### 关键监控指标
1. **执行时间**：各模块的执行时长趋势
2. **处理数据量**：文件大小和记录数
3. **错误率**：各类错误的发生频率
4. **资源使用**：CPU、内存、磁盘使用情况

### 告警策略
1. **超时告警**：执行时间超过阈值
2. **失败告警**：返回非0状态码
3. **数据量异常**：处理记录数异常波动
4. **重复执行告警**：返回100状态码

## 未来扩展建议

### 1. 配置文件化
将硬编码的配置项提取到配置文件：
```bash
# config/ccllna_acct.conf
API_BASE_URL="http://tms-app-cdc:19201"
CONNECT_TIMEOUT=30
MAX_TIME=1800
MAINTAIN_DATE_COL=47
```

### 2. 统一的公共函数库
提取公共功能到共享脚本：
```bash
# common/functions.sh
tmsLock() { ... }
tmsUnlock() { ... }
logInfo() { ... }
logError() { ... }
callAPI() { ... }
```

### 3. 增强错误恢复机制
- 自动重试机制
- 断点续传功能
- 数据一致性检查

### 4. 性能监控集成
- 集成APM工具
- 添加性能指标收集
- 实现自动性能调优