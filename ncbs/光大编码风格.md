# 光大银行Java编码风格规范

## 1. 概述

本文档基于光大银行税务管理系统的实际开发实践，定义了Java代码的编写风格和规范，旨在提高代码质量、可读性和可维护性。

### 1.1 适用范围
- 税务管理系统Java开发
- Shell与Java混合架构项目
- 微服务架构开发
- API接口开发

### 1.2 技术栈
- **框架**: JAX-RS + Spring Boot
- **ORM**: JPA + Hibernate
- **数据库**: MySQL 5.7+
- **工具库**: Hutool、Lombok、FastJSON
- **日志**: CSPS Logger
- **事务**: Spring Transaction

## 2. 注解规范

### 2.1 Controller层注解
```java
@Component                                    // 必须使用@Component，不使用@RestController
@Consumes({ MediaType.APPLICATION_JSON })     // 指定消费类型
@Produces({ MediaType.APPLICATION_JSON })     // 指定生产类型
@Path("ncbs-cgmdab-cl-loan-rlvc")            // JAX-RS路径，使用短横线分隔
public class NcbsCgmdabClLoanRlvcController extends ControllerSupport {
    
    @POST                                     // HTTP方法注解
    @Path("sync")                            // 具体方法路径
    @AspLog(title = "操作描述", 
            bizType = AuditOpBizType.UPDATE, 
            isSaveRequestData = false)        // 操作日志注解
    public ResultVo sync(@RequestBody DataSyncRequest request) throws Exception {
        // 方法实现
    }
}
```

### 2.2 Service层注解
```java
@Service                                      // 服务层注解
@Transactional(rollbackFor = Exception.class, 
               value = "utaxTransactionManager")  // 事务注解，指定事务管理器
public class NcbsCgmdabClLoanRlvcServiceImpl extends BaseServiceImpl {
    // 实现代码
}
```

### 2.3 实体类注解
```java
@JsonIgnoreProperties(ignoreUnknown = true)   // 忽略未知JSON属性
@Data                                         // Lombok数据注解
@Entity                                       // JPA实体注解
@Table(name = "tp_ncbs_cgmdab_cl_loan_rlvc") // 表名映射
public class NcbsCgmdabClLoanRlvc implements Serializable {
    
    @Id
    @Column(name = "id")
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "commute_debt_ast_no")     // 字段映射
    private String commuteDebtAstNo;
}
```

### 2.4 Repository层注解
```java
@Repository                                   // 数据访问层注解
public interface NcbsCgmdabClLoanRlvcRepository extends BaseDao<NcbsCgmdabClLoanRlvc, Long> {
    
    @Query("from NcbsCgmdabClLoanRlvc t where t.id = ?1")  // 自定义查询
    NcbsCgmdabClLoanRlvc queryById(Long id);
    
    @Modifying                               // 修改操作注解
    @Query("delete from NcbsCgmdabClLoanRlvc t where t.id = ?1")
    void deleteById(Long id);
}
```

## 3. 依赖注入规范

### 3.1 使用@Resource注解
```java
@Resource                                     // 推荐使用@Resource，不使用@Autowired
private NcbsCgmdabClLoanRlvcService ncbsCgmdabClLoanRlvcService;

@Resource
private JdbcTemplate jdbcTemplate;
```

### 3.2 依赖注入原则
- 优先使用`@Resource`注解
- 避免使用`@Autowired`
- 服务层注入使用接口类型
- 数据层注入使用具体实现

## 4. 日志记录规范

### 4.1 日志声明
```java
// 使用CSPS Logger，不使用其他日志框架
private static CSPSLogger log = CSPSLogFactory.get(NcbsCgmdabClLoanRlvcController.class);
```

### 4.2 日志记录方式
```java
// 信息日志 - 使用StrUtil.format进行字符串格式化
log.info(StrUtil.format("开始处理抵债资产对公贷款关联表数据同步请求:{}", JSON.toJSONString(request)));

// 错误日志
log.error("抵债资产对公贷款关联表数据同步失败", e);

// 调试日志 - 使用StrUtil.format
log.info(StrUtil.format("批量插入完成，当前总记录数: {}", JSON.toJSONString(totalRows)));

// 警告日志 - 多参数格式化
log.info(StrUtil.format("数据行字段数不正确，期望49个字段，实际{}个字段: {}", fields.length, JSON.toJSONString(line)));

// 业务完成日志
log.info(StrUtil.format("抵债资产对公贷款关联表数据同步完成:{}", JSON.toJSONString(result)));
```

### 4.3 日志记录原则
- 关键业务操作必须记录日志
- 异常信息必须记录详细堆栈
- **使用`StrUtil.format()`进行字符串格式化，不使用占位符`{}`**
- **对象参数使用`JSON.toJSONString()`序列化，确保日志可读性**
- 避免字符串拼接
- 日志内容使用中文描述
- 数值类型也建议使用`JSON.toJSONString()`保持格式一致性

## 5. 返回结果规范

### 5.1 成功返回
```java
// 带数据的成功返回
return ResultVo.success(result);

// 无数据的成功返回
return ResultVo.success();

// 继承ControllerSupport的成功返回
return super.success(ncbsCgmdabClLoanRlvcOutVO);
```

### 5.2 错误返回
```java
// 单个错误信息
return ResultVo.error("请求参数不能为空");

// 多个错误信息
List<String> errList = new ArrayList<>();
errList.add("文件路径不能为空");
errList.add("处理日期不能为空");
return ResultVo.error(StrUtil.join(UTaxConstant.COMMA, errList));
```

### 5.3 返回格式标准
```java
// 标准成功响应
{
    "code": "1000",
    "message": "操作成功",
    "data": { ... },
    "success": true
}

// 标准错误响应
{
    "code": "9999", 
    "message": "错误信息",
    "data": null,
    "success": false
}
```

## 6. 异常处理规范

### 6.1 统一异常处理模式
```java
try {
    // 业务逻辑处理
    Object result = ncbsCgmdabClLoanRlvcService.syncData(request);
    log.info("操作完成: {}", result);
    return ResultVo.success(result);
    
} catch (Exception e) {
    log.error("操作失败", e);
    errList.add("操作失败:" + e.getMessage());
    return ResultVo.error(StrUtil.join(UTaxConstant.COMMA, errList));
}
```

### 6.2 异常处理原则
- 所有公共方法必须进行异常处理
- 异常信息必须记录到日志
- 向上抛出的异常必须包含业务含义
- 不允许捕获异常后不处理
- 异常信息使用中文描述

## 7. 参数验证规范

### 7.1 使用Hutool工具类
```java
// 空值检查
if (StrUtil.isBlank(request.getFilePath())) {
    errList.add("文件路径不能为空");
    return ResultVo.error(StrUtil.join(UTaxConstant.COMMA, errList));
}

// 对象空值检查
if (request == null) {
    errList.add("请求参数不能为空");
    return ResultVo.error(StrUtil.join(UTaxConstant.COMMA, errList));
}
```

### 7.2 验证顺序
1. 对象非空验证
2. 必填字段验证
3. 格式验证
4. 业务规则验证

### 7.3 错误信息收集
```java
List<String> errList = new ArrayList<>();

// 收集所有验证错误
if (request == null) {
    errList.add("请求参数不能为空");
}
if (StrUtil.isBlank(request.getFilePath())) {
    errList.add("文件路径不能为空");
}

// 有错误时统一返回
if (!errList.isEmpty()) {
    return ResultVo.error(StrUtil.join(UTaxConstant.COMMA, errList));
}
```

## 8. 事务管理规范

### 8.1 事务注解使用
```java
@Override
@Transactional(rollbackFor = Exception.class, value = "utaxTransactionManager")
public DataSyncResult syncData(DataSyncRequest request) throws Exception {
    // 事务方法实现
}
```

### 8.2 事务管理原则
- 数据修改操作必须使用事务
- 指定具体的事务管理器名称
- 设置`rollbackFor = Exception.class`
- 长时间运行的操作考虑事务超时
- 避免事务嵌套过深

## 9. 命名规范

### 9.1 类命名
```java
// Controller类
NcbsCgmdabClLoanRlvcController

// Service接口
NcbsCgmdabClLoanRlvcService

// Service实现类
NcbsCgmdabClLoanRlvcServiceImpl

// Repository接口
NcbsCgmdabClLoanRlvcRepository

// 实体类
NcbsCgmdabClLoanRlvc

// VO类
DataSyncRequest, DataSyncResult, NcbsCgmdabClLoanRlvcOutVO
```

### 9.2 方法命名
```java
// 查询方法
queryById(), listPage(), queryInfoById()

// 保存方法
saveOrUpdate(), save(), update()

// 删除方法
deleteById(), deleteAllByIds()

// 业务方法
syncData(), importDataFromFile(), buildInsertSql()
```

### 9.3 变量命名
```java
// 业务变量
private String commuteDebtAstNo;          // 抵债资产编号
private String lnDueBillNo;               // 借据号
private BigDecimal credAstImpaiProvis;    // 信贷资产减值准备

// 工具变量
List<String> errList = new ArrayList<>();
String insertSql = buildInsertSql(tableName);
long totalRows = 0;
```

### 9.4 常量命名
```java
// 常量定义
private static final String DATA_SEPARATOR = "\\|\\+\\|";
private static final int BATCH_SIZE = 1000;
public static final String FIELD_SAVE = "createUserId,createUserName,createTime";
```

## 10. 代码注释规范

### 10.1 类注释
```java
/**
 * 资产损失:临时表-抵债资产对公贷款关联表表控制层
 * <pre>
 * 主要功能：
 * 1. 提供CRUD操作接口
 * 2. 数据同步接口
 * 3. 参数验证和异常处理
 * </pre>
 * @author 系统重构
 * @version V2.0.0
 * @see ControllerSupport
 * @since 2025-08-25
 * @date 2025-08-25 10:00:00
 */
```

### 10.2 方法注释
```java
/**
 * 数据同步接口
 * @param request 数据同步请求参数
 * @return ResultVO 同步结果
 * @throws Exception 同步异常
 * @see DataSyncRequest
 * @since V2.0.0
 */
```

### 10.3 字段注释
```java
/**        
 * 抵债资产编号
 */
@Column(name = "commute_debt_ast_no")
private String commuteDebtAstNo;
```

### 10.4 行内注释
```java
// 1. 清空目标表
truncateTable(request.getTableName());

// 2. 读取文件并插入数据
long importedRows = importDataFromFile(dataFile, request.getTableName());

// 参考demo.sh的调用方式：直接在curl中使用管道检查成功标识
result=`curl -s $time_url -X POST $api_url | grep '"success":true'|wc -l`
```

## 11. 文件组织规范

### 11.1 包结构
```
com.cebbank.tms.wenjing.ift.
├── controller/          # 控制器层
├── service/            # 服务接口层
├── service.impl/       # 服务实现层
├── dao/               # 数据访问层
├── domain/            # 实体类
├── vo/                # 值对象
│   ├── in/            # 输入VO
│   └── out/           # 输出VO
└── config/            # 配置类
```

### 11.2 导入顺序
```java
// 1. JDK标准库
import java.util.List;
import java.util.ArrayList;

// 2. 第三方库
import lombok.Data;
import cn.hutool.core.util.StrUtil;
import com.alibaba.fastjson.JSON;           // FastJSON序列化工具

// 3. Spring框架
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

// 4. 项目内部包
import com.cebbank.tms.wenjing.common.base.ResultVo;
import com.cebbank.tms.wenjing.ift.domain.NcbsCgmdabClLoanRlvc;
```

## 12. 数据库操作规范

### 12.1 JPA查询
```java
// 使用@Query注解
@Query("from NcbsCgmdabClLoanRlvc t where t.id = ?1")
NcbsCgmdabClLoanRlvc queryById(Long id);

// 使用方法命名查询
List<NcbsCgmdabClLoanRlvc> findByCommuteDebtAstNo(String commuteDebtAstNo);
```

### 12.2 原生SQL操作
```java
// 使用JdbcTemplate进行批量操作
String sql = "INSERT INTO table_name (...) VALUES (...)";
jdbcTemplate.batchUpdate(sql, batchArgs);

// 表清空操作
String truncateSql = "TRUNCATE TABLE " + tableName;
jdbcTemplate.execute(truncateSql);
```

### 12.3 事务操作
```java
@Transactional(rollbackFor = Exception.class, value = "utaxTransactionManager")
public void batchOperation() {
    // 1. 清空表
    // 2. 批量插入
    // 3. 更新状态
}
```

## 13. API设计规范

### 13.1 RESTful路径设计
```java
@Path("ncbs-cgmdab-cl-loan-rlvc")           // 资源路径，使用短横线
public class Controller {
    
    @GET
    @Path("get/{id}")                        // 获取单个资源
    
    @POST  
    @Path("save-update")                     // 保存或更新
    
    @POST
    @Path("page-list")                       // 分页查询
    
    @POST
    @Path("delete-by-id/{id}")               // 删除单个
    
    @POST
    @Path("sync")                            // 业务操作
}
```

### 13.2 请求响应格式
```java
// 请求格式
{
    "filePath": "/path/to/file",
    "processDate": "2025-08-25",
    "tableName": "table_name"
}

// 响应格式
{
    "code": "1000",
    "message": "操作成功", 
    "data": { ... },
    "success": true
}
```

## 14. 工具类使用规范

### 14.1 Hutool工具类
```java
// 字符串工具
StrUtil.isBlank(str)                        // 空值判断
StrUtil.join(UTaxConstant.COMMA, errList)   // 字符串连接
StrUtil.format("数据同步完成: {}", JSON.toJSONString(result))  // 字符串格式化

// 文件工具
FileUtil.readLines(file, StandardCharsets.UTF_8)  // 文件读取

// 集合工具
CollUtil.isEmpty(list)                      // 集合判空
```

### 14.2 FastJSON工具类
```java
// 对象序列化 - 日志记录中使用
log.info(StrUtil.format("开始处理请求: {}", JSON.toJSONString(request)));

// 数值序列化 - 保持格式一致性
log.info(StrUtil.format("导入记录数: {}", JSON.toJSONString(totalRows)));

// 复杂对象序列化
log.info(StrUtil.format("处理结果: {}", JSON.toJSONString(result)));
```

### 14.3 BeanCopyUtil使用
```java
// 对象复制
NcbsCgmdabClLoanRlvcOutVO vo = new NcbsCgmdabClLoanRlvcOutVO();
BeanCopyUtil.copyObject(entity, vo);
```

## 15. 性能优化规范

### 15.1 批量操作
```java
// 设置合理的批量大小
private static final int BATCH_SIZE = 1000;

// 批量插入
List<Object[]> batchArgs = new ArrayList<>();
if (batchArgs.size() >= BATCH_SIZE) {
    jdbcTemplate.batchUpdate(insertSql, batchArgs);
    batchArgs.clear();
}
```

### 15.2 资源管理
```java
// 使用try-with-resources
try (BufferedReader reader = new BufferedReader(new FileReader(file))) {
    // 文件操作
}

// 及时释放大对象
List<String> lines = FileUtil.readLines(file, StandardCharsets.UTF_8);
// 处理完成后
lines = null;
```

## 16. 测试规范

### 16.1 单元测试
```java
@Test
public void testSyncData() {
    // Given
    DataSyncRequest request = new DataSyncRequest();
    request.setFilePath("/test/file/path");
    
    // When
    DataSyncResult result = service.syncData(request);
    
    // Then
    assertNotNull(result);
    assertEquals("表名", result.getTableName());
}
```

### 16.2 集成测试
```java
@Test
public void testSyncApi() throws Exception {
    // 模拟HTTP请求测试
    mockMvc.perform(post("/ncbs-cgmdab-cl-loan-rlvc/sync")
            .contentType(MediaType.APPLICATION_JSON)
            .content(requestJson))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.success").value(true));
}
```

## 17. 代码检查清单

### 17.1 提交前检查
- [ ] 所有注解是否正确使用
- [ ] **日志记录是否使用`StrUtil.format()`和`JSON.toJSONString()`**
- [ ] 异常处理是否到位
- [ ] 参数验证是否充分
- [ ] 事务注解是否正确
- [ ] 方法注释是否完整
- [ ] 命名是否规范
- [ ] 返回格式是否统一
- [ ] **FastJSON导入是否正确**

### 17.2 代码审查要点
- [ ] 业务逻辑是否正确
- [ ] 性能是否优化
- [ ] 安全性是否考虑
- [ ] 可维护性是否良好
- [ ] 错误处理是否完善
- [ ] 日志信息是否有用
- [ ] 测试覆盖是否充分

## 18. 常见错误及避免

### 18.1 注解使用错误
```java
// ❌ 错误：使用Spring MVC注解
@RestController
@RequestMapping("/api")

// ✅ 正确：使用JAX-RS注解
@Component
@Path("ncbs-cgmdab-cl-loan-rlvc")
```

### 18.2 日志使用错误
```java
// ❌ 错误：使用其他日志框架
private static final Logger logger = LoggerFactory.getLogger(XXX.class);

// ✅ 正确：使用CSPS Logger
private static CSPSLogger log = CSPSLogFactory.get(XXX.class);
```

### 18.3 日志使用错误
```java
// ❌ 错误：使用其他日志框架
private static final Logger logger = LoggerFactory.getLogger(XXX.class);

// ✅ 正确：使用CSPS Logger
private static CSPSLogger log = CSPSLogFactory.get(XXX.class);
```

### 18.4 日志格式化错误
```java
// ❌ 错误：使用占位符{}
log.info("开始处理请求: {}", request);
log.debug("导入记录数: {}", totalRows);

// ✅ 正确：使用StrUtil.format和JSON序列化
log.info(StrUtil.format("开始处理请求: {}", JSON.toJSONString(request)));
log.info(StrUtil.format("导入记录数: {}", JSON.toJSONString(totalRows)));
```

### 18.5 事务使用错误
```java
// ❌ 错误：未指定事务管理器
@Transactional

// ✅ 正确：指定事务管理器
@Transactional(rollbackFor = Exception.class, value = "utaxTransactionManager")
```

## 19. 版本信息

- **文档版本**: V1.0.0
- **创建日期**: 2025-08-25
- **适用系统**: 光大银行税务管理系统
- **维护人**: 系统重构团队

---

**注意**: 本规范基于光大银行实际项目经验制定，所有开发人员必须严格遵循。如有疑问或建议，请联系架构团队。